<!DOCTYPE html>
<html lang="fr" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kumite</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
    <style>
        @media (min-width: 576px) {
            .jumbotron {
                padding: 2rem 1rem;
            }
        }

        .jumbotron {
            margin-bottom: 0;
        }

        .NOIR {
            background-color: black;
            color: whitesmoke;
        }

        .MARON {
            background-color: brown;
            color: whitesmoke;
        }

        .BLEU {
            background-color: blue;
            color: whitesmoke;
        }

        .VERT {
            background-color: green;
            color: whitesmoke;
        }

        .ORANGE {
            background-color: orange;
        }

        .JAUNE {
            background-color: yellow;
        }

        .BLANC {
            background-color: white;
        }

    </style>
    <script src="https://fr.vuejs.org/js/vue.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script>
        const typeEnvoieConnection = "CONNECTION";
        const typeEnvoieSpectateur = "SPECTATEUR";
        const typeEnvoieAttenteCombat = "ATTENTECOMBAT";
        const typeEnvoieBlancQuitter = "BLANCQUITTER";
        const typeEnvoieRougeQuitter = "ROUGEQUITTER";
    </script>
</head>
<body>
<div id="salle" class="jumbotron jumbotron-fluid">
    <div class="container-fluid">
        <div class="fixed-top bg-dark p-4">
            <div>
                <h2 class="text-center text-light">Kumite</h2>
                <a href="/" class="btn btn-primary">&laquo; Retour au dojo</a>
            </div>
            <br />
            <div class="row">
                <div class="col-3 mr-5">
                    <h4 class="text-light">Profile</h4>
                    <div id="profile" class="media bg-light border">
                        <img th:src="${profile.getAvatar().getImgAvatar()}" class="media-object">
                        <div class="media-body">
                            <span th:text="${profile.getAlias()}"></span><br/>
                            Ceinture: <span th:text="${profile.getGroupe().getGroupe()}"></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br/>
        <div id="spectateur" style="margin-top: 18rem;">
            <h4>Les spectateurs</h4>
            <div class="d-flex border border-info rounded" style="min-height: 140px;">
                <div class="m-3" :class="spect.groupe" v-for="spect in Spectateur">
                    <img :src="spect.avatar.imgAvatar"><br/>
                    {{spect.alias}}
                </div>
            </div>
        </div>
        <br/>
        <div id="competiteur" >
            <h4>En attente de combat</h4>
            <div class="d-flex border border-info rounded" style="min-height: 140px;">
                <div class="m-3" :class="attente.groupe" v-for="attente in AttenteCombat">
                    <img :src="attente.avatar.imgAvatar"><br/>
                    {{attente.alias}}
                </div>
            </div>
        </div>
        <br/>
        <div id="divTatami">
            <h4>Tatami</h4>
            <div class="d-flex border border-info rounded p-4 justify-content-between" style="min-height: 200px;">
                <div id="divCombatantBlanc" >
                    <div v-if="Blanc">
                        <img :src="Blanc.avatar.imgAvatar">
                    </div>
                </div>
                <div id="divChoixBlanc">
                    <div>
                        <img :src="ActionCombat[BlancAtt]">
                    </div>
                </div>
                <div id="divVictoireBlanc">

                </div>
                <div id="divArbite" >
                    <div v-if="Arbite">
                        <img :src="Arbite.avatar.imgAvatar">
                    </div>

                </div>
                <div id="divVictoireRouge">

                </div>
                <div id="divChoixRouge" v-if="RougeAtt">
                    <img :src="ActionCombat[RougeAtt]">
                </div>
                <div id="divCombatantRouge" >
                    <div v-if="Rouge">
                        <img :src="Rouge.avatar.imgAvatar">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var salle = new Vue({
       el: "#salle",
        data: {
           CompteProfile: "",
            Courriel: "[[${profile.getCourriel()}]]",
            Emplacement: "",
            Spectateur: [],
            AttenteCombat: [],
            Arbite: "",
            Rouge: "",
            Blanc: "",
            ChoixResultat: {
                1: {text: "Blanc", variant: "btn btn-light"},
                2: {text: "Égalité", variant: "btn btn-secondary"},
                3: {text: "Rouge", variant: "btn btn-danger"}
            },
            Resultat: null,
            ActionCombat: {
                "ROCHE" : "/images/roche.jpg",
                "PAPIER" : "/images/papier.jpg",
                "CISEAU" : "/images/ciseau.jpg"
            },
            ActionCombatant: null,
            BlancAtt: "",
            RougeAtt: "",
            FinCombat: "",
        },
       methods: {
           envoie: function(type) {

               if (this.stompClient && this.stompClient.connected) {
                   switch (type) {
                       case typeEnvoieConnection:
                           this.stompClient.send("/app/seConnectKumite", {},this.Courriel);
                           break;
                   }
               }
           },
           connect() {
               this.socket = new SockJS("/webSocket");
               this.stompClient = Stomp.over(this.socket);
               this.stompClient.connect({url: window.location.href }, frame => {
                   this.seConnect();
                    },
                   error => {
                       console.log(error);
                       this.connected = false;
                   }
                );
           },
            seConnect() {
                this.connected = true;
                this.stompClient.subscribe("/kumite/connexion", tick => {
                    let laSalle = JSON.parse(tick.body);
                    this.Spectateur = laSalle.lesSpectateurs;
                    this.AttenteCombat = laSalle.lesAttentesCombat;
                    this.Arbite = laSalle.arbite;
                    this.Rouge = laSalle.rouge;
                    this.Blanc = laSalle.blanc;

                    if (this.CompteProfile === "") {
                        this.CompteProfile = this.Spectateur[0];
                    }

                });

                this.stompClient.subscribe("/kumite/majSpectateur", tick => {
                   let repSpect = JSON.parse(tick.body);
                   this.maj(this.Spectateur,repSpect.strAction,repSpect.compte);
                });

                this.stompClient.subscribe("/kumite/majAttenteCombat", tick => {
                    let repAtt = JSON.parse(tick.body);
                    this.maj(this.AttenteCombat, repAtt.strAction,repAtt.compte);
                });

                this.stompClient.subscribe("/kumite/majArbite", tick => {
                   let repArbite = JSON.parse(tick.body);

                   if (repArbite.strAction === "AJOUT") {
                       this.Arbite = repArbite.compte;

                   }
                   else if (repArbite.strAction === "RETRAIT") {
                       this.Arbite = "";
                       this.Resultat = null;
                   }
                });

                this.stompClient.subscribe("/kumite/majCombatantRouge", tick => {
                    let repCombatantRouge = JSON.parse(tick.body);

                    if (repCombatantRouge.strAction === "AJOUT") {
                        this.Rouge = repCombatantRouge.compte;

                    }
                    else if (repCombatantRouge.strAction === "RETRAIT"){
                        if (this.CompteProfile.courriel === this.Rouge.courriel) {
                            this.ActionCombatant = null;
                        }

                        this.Rouge = null;
                        this.RougeAtt = "";

                        //Il n'y a pu de combatant, donc le précèdant combat n'est plus ...
                        if (!this.Blanc) {
                            this.FinCombat = "";
                            this.Resultat = null;
                        }
                    }
                    else  {
                        this.RougeAtt = repCombatantRouge.strAction;
                    }
                });

                this.stompClient.subscribe("/kumite/majCombatantBlanc", tick => {
                    let repCombatantBlanc = JSON.parse(tick.body);

                    if(repCombatantBlanc.strAction === "AJOUT") {
                        this.Blanc = repCombatantBlanc.compte;
                    }
                    else if (repCombatantBlanc.strAction === "RETRAIT")  {
                        if (this.CompteProfile.courriel === this.Blanc.courriel) {
                            this.ActionCombatant = null;
                        }

                        this.Blanc = null;
                        this.BlancAtt = "";

                        //Il n'y a pu de combatant, donc le présédant combat n'est plus ...
                        if (!this.Rouge) {
                            this.FinCombat = "";
                            this.Resultat = null;
                        }
                    }
                    else {
                        this.BlancAtt = repCombatantBlanc.strAction;
                    }
                });

                this.stompClient.subscribe("/kumite/conclusionCombat", tick => {
                    let repConclusion = tick.body;

                    switch (repConclusion) {
                        case "Blanc":
                        case typeEnvoieRougeQuitter:
                            this.FinCombat = "Blanc";
                            break;
                        case "Rouge":
                        case typeEnvoieBlancQuitter:
                            this.FinCombat = "Rouge";
                            break;
                        case "Égalité":
                            this.FinCombat = "Égalité";
                            break;
                    }
                });

                this.envoie(typeEnvoieConnection);
            },
           majPosition(){
               //Bloque l'envoie de changement de possition quand le levier (spectateur/attentecombat) est réinitialisé
               if (this.Arbite != null ? (this.Arbite.courriel !== this.CompteProfile.courriel): true) {
                   if(this.Emplacement) {
                       this.envoie(typeEnvoieAttenteCombat);
                   }
                   else {
                       this.envoie(typeEnvoieSpectateur);
                   }
               }
           },
           maj: function(liste,action,qui){

               if (action === "AJOUT") {
                   liste.unshift(qui);
               }
               else {
                   liste.splice(liste.findIndex(element => element.courriel === qui.courriel),1);
               }
           }
       },
        mounted(){
            this.connect();
        }
    });
</script>
</body>
</html>